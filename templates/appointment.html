{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Qabulga Yozilish - DentCare{% endblock %}
{% block body_class %}appointment-page{% endblock %}
{% block heading_title %}Qabulga Yozilish{% endblock %}
{% block heading_desc %}Onlayn qabulga yozilish tizimi orqali qulay vaqtni tanlang va professional stomatologiya xizmatidan bahramand bo'ling{% endblock %}
{% block breadcrumb %}Qabulga Yozilish{% endblock %}

{% block content %}

    <!-- Appointment Section -->
    <section id="appointment" class="appointment section">

      <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div class="row gy-4">

          <!-- Appointment Info -->
          <div class="col-lg-6">
            <div class="appointment-info">
              <h3>Tez va Oson Onlayn Qabulga Yozilish</h3>
              <p class="mb-4">Qabulga yozilish uchun bir necha bosqichni to'ldiring. Bizning professional tish shifokorlarimiz sizga eng yaxshi xizmatni ko'rsatishga tayyor.</p>

              <div class="info-items">
                <div class="info-item d-flex align-items-center mb-3" data-aos="fade-up" data-aos-delay="200">
                  <div class="icon-wrapper me-3">
                    <i class="bi bi-calendar-check"></i>
                  </div>
                  <div>
                    <h5>Moslashuvchan Jadval</h5>
                    <p class="mb-0">Band jadvlingizga mos keladigan qulay vaqtni tanlang</p>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center mb-3" data-aos="fade-up" data-aos-delay="250">
                  <div class="icon-wrapper me-3">
                    <i class="bi bi-stopwatch"></i>
                  </div>
                  <div>
                    <h5>Tezkor Javob</h5>
                    <p class="mb-0">Arizangizni yuborgan 15 daqiqada tasdiqlash xabarini oling</p>
                  </div>
                </div>

                <div class="info-item d-flex align-items-center mb-3" data-aos="fade-up" data-aos-delay="300">
                  <div class="icon-wrapper me-3">
                    <i class="bi bi-shield-check"></i>
                  </div>
                  <div>
                    <h5>Professional Davolash</h5>
                    <p class="mb-0">Yuqori malakali va sertifikatlangan tish shifokorlari xizmatingizda</p>
                  </div>
                </div>
                <div class="container mt-3">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
              </div>

              <div class="emergency-contact mt-4" data-aos="fade-up" data-aos-delay="350">
                <div class="emergency-card p-3">
                  <h6 class="mb-2"><i class="bi bi-telephone-fill me-2"></i>Tez Yordam Telefoni</h6>
                  <p class="mb-0">Shoshilinch stomatologik yordam uchun <strong>+998 71 123 45 67</strong> raqamiga qo'ng'iroq qiling</p>
                </div>
              </div>

            </div>
          </div><!-- End Appointment Info -->

          <!-- Appointment Form -->
          <div class="col-lg-6">
            <div class="appointment-form-wrapper" data-aos="fade-up" data-aos-delay="200">
              <form action="{% url 'appointment' %}" method="post" role="form" class="php-email-form">
                {% csrf_token %}

                {% if form.errors %}
                  <div class="alert alert-danger">
                    Iltimos, xatolarni to'g'rilang va qaytadan urinib ko'ring.
                  </div>
                {% endif %}

                <div class="row">
                  <div class="col-md-4 form-group mt-3">
                    {{ form.name.label_tag }}
                    {{ form.name }}
                    {{ form.name.errors }}
                  </div>
                  <div class="col-md-4 form-group mt-3">
                    {{ form.phone.label_tag }}
                    {{ form.phone }}
                    {{ form.phone.errors }}
                  </div>
                  <div class="col-md-4 form-group mt-3">
                    {{ form.department.label_tag }}
                    {{ form.department }}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4 form-group mt-3">
                    {{ form.doctor.label_tag }}
                    {{ form.doctor }}
                  </div>
                  <div class="col-md-4 form-group mt-3">
                    {{ form.appointment_date.label_tag }}
                    {{ form.appointment_date }}
                  </div>
                  <div class="col-md-4 form-group mt-3">
                    {{ form.appointment_time.label_tag }}
                    {{ form.appointment_time }}
                  </div>
                </div>

                <div class="form-group mt-3">
                  {{ form.message.label_tag }}
                  {{ form.message }}
                </div>

                <div class="mt-3">
                  <div class="loading">Yuklanmoqda...</div>
                  <div class="error-message"></div>
                  <div class="sent-message">Sizning qabulga yozilish so'rovingiz yuborildi. Rahmat!</div>
                  <div class="text-center">
                    <button type="submit" class="appointment-btn">Qabulga Yozilish</button>
                  </div>
                </div>
              </form>
            </div>
          </div><!-- End Appointment Form -->

        </div>

        <!-- Process Steps -->
        <div class="process-steps mt-5" data-aos="fade-up" data-aos-delay="300">
          <div class="row text-center gy-4">
            <div class="col-lg-3 col-md-6">
              <div class="step-item">
                <div class="step-number">1</div>
                <div class="step-icon">
                  <i class="bi bi-person-fill"></i>
                </div>
                <h5>Ma'lumotlarni To'ldirish</h5>
                <p>Shaxsiy ma'lumotlaringizni kiriting va kerakli bo'limni tanlang</p>
              </div>
            </div>

            <div class="col-lg-3 col-md-6">
              <div class="step-item">
                <div class="step-number">2</div>
                <div class="step-icon">
                  <i class="bi bi-calendar-event"></i>
                </div>
                <h5>Sana va Vaqt Tanlash</h5>
                <p>Bo'sh vaqtlar ichidan sizga qulay sanani tanlang</p>
              </div>
            </div>

            <div class="col-lg-3 col-md-6">
              <div class="step-item">
                <div class="step-number">3</div>
                <div class="step-icon">
                  <i class="bi bi-check-circle"></i>
                </div>
                <h5>Tasdiqlash</h5>
                <p>Email yoki SMS orqali tasdiqlash xabarini oling</p>
              </div>
            </div>

            <div class="col-lg-3 col-md-6">
              <div class="step-item">
                <div class="step-number">4</div>
                <div class="step-icon">
                  <i class="bi bi-heart-pulse"></i>
                </div>
                <h5>Davolash</h5>
                <p>Belgilangan vaqtda klinikaga tashrif buyuring va sifatli xizmat oling</p>
              </div>
            </div>

          </div>
        </div><!-- End Process Steps -->

      </div>

    </section><!-- /Appointment Section -->

    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const doctorSelect = document.querySelector('select[name="doctor"]');
          const dateInput = document.querySelector('input[name="appointment_date"]');
          const timeSelect = document.querySelector('select[name="appointment_time"]');

          function updateAvailableTimes() {
              const doctorId = doctorSelect.value;
              const date = dateInput.value;

              if (doctorId && date) {
                  fetch(`/get-available-times/?doctor_id=${doctorId}&date=${date}`)
                      .then(response => response.json())
                      .then(data => {
                          const bookedTimes = data.booked_times;

                          // Vaqt tanlash qismidagi har bir variantni tekshiramiz
                          Array.from(timeSelect.options).forEach(option => {
                              if (bookedTimes.includes(option.value)) {
                                  option.disabled = true;
                                  option.style.color = '#ccc';
                                  option.text = option.value + ' (Band)';
                              } else {
                                  option.disabled = false;
                                  option.style.color = '#000';
                                  option.text = option.value;
                              }
                          });
                      });
              }
          }

          doctorSelect.addEventListener('change', updateAvailableTimes);
          dateInput.addEventListener('change', updateAvailableTimes);
      });
    </script>



    <script>
      document.querySelector('select[name="department"]').addEventListener('change', function() {
          const departmentId = this.value;
          const doctorSelect = document.querySelector('select[name="doctor"]');

          // Avvalgi shifokorlarni tozalash
          doctorSelect.innerHTML = '<option value="">Shifokorni tanlang</option>';

          if (departmentId) {
              fetch(`/ajax/load-doctors/?department_id=${departmentId}`)
                  .then(response => response.json())
                  .then(data => {
                      data.forEach(doctor => {
                          const option = document.createElement('option');
                          option.value = doctor.id;
                          option.textContent = doctor.name;
                          doctorSelect.appendChild(option);
                      });
                  });
          }
      });
    </script>


    <script>
      function updateAvailableTimes() {
          const doctorId = document.getElementById('id_doctor').value;
          const date = document.getElementById('id_appointment_date').value;
          const timeSelect = document.getElementById('id_appointment_time');

          if (doctorId && date) {
              fetch(`/get-available-times/?doctor_id=${doctorId}&date=${date}`)
                  .then(res => res.json())
                  .then(data => {
                      timeSelect.innerHTML = '<option value="">Vaqtni tanlang</option>';
                      if (data.error) {
                          alert(data.error);
                      } else if (data.available_slots) {
                          data.available_slots.forEach(slot => {
                              const option = document.createElement('option');
                              option.value = slot;
                              option.textContent = slot;
                              timeSelect.appendChild(option);
                          });
                      }
                  });
              }
          }
      // Poyloqchilar (Listeners)
      document.getElementById('id_doctor').addEventListener('change', updateAvailableTimes);
      document.getElementById('id_appointment_date').addEventListener('change', updateAvailableTimes);
    </script>

{% endblock %}